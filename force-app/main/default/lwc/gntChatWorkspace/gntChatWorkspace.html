<template>
    <lightning-card title={cardTitle} icon-name="utility:chat">
        <div class="slds-p-around_small composer">
            <lightning-input
                data-name="title"
                label="スレッドを開始する"
                placeholder="タイトルを入力"
                maxlength="80"
                value={newThreadTitle}
                onchange={handleTitleChange}
            ></lightning-input>
            <lightning-textarea
                class="slds-m-top_x-small"
                data-name="firstComment"
                label="最初のコメント"
                placeholder="最初のコメントを入力"
                maxlength="1000"
                value={firstComment}
                onchange={handleFirstCommentChange}
            ></lightning-textarea>
            <div class="counter">{firstCommentCount}/1000</div>
            <lightning-button
                class="slds-m-top_x-small"
                label="投稿"
                variant="brand"
                disabled={disableCreate}
                onclick={createThread}
            ></lightning-button>
        </div>

        <div class="slds-p-horizontal_small">
            <template if:true={threads}>
                <lightning-accordion allow-multiple-sections-open onsectiontoggle={handleToggle} active-section-name={openSectionNames}>
                    <template for:each={threads} for:item="t">
                        <lightning-accordion-section key={t.Id} name={t.Id} label={t.Name}>
                            <div class="thread">
                                <template if:true={t.messagesLoaded}>
                                    <div class="messages-box" data-id={t.Id} onscroll={handleScrollMessages}>
                                    <template for:each={t.messages} for:item="m">
                                        <div key={m.Id} class="post">
                                            <div class="post__header">
                                                <span class="post__author">
                                                    {m.displayAuthor}
                                                </span>
                                                <span class="post__time">
                                                    {m.displayTime}
                                                    <span class="post__icons">
                                                        <template if:true={m.isSynced}>
                                                            <lightning-icon icon-name="utility:success" variant="success" size="x-small" title="同期済み"></lightning-icon>
                                                        </template>
                                                        <template if:true={m.isPending}>
                                                            <lightning-icon icon-name="utility:sync" size="x-small" title="連携保留"></lightning-icon>
                                                        </template>
                                                        <template if:true={m.isFailed}>
                                                            <lightning-icon icon-name="utility:warning" variant="error" size="x-small" title={m.statusTitle}></lightning-icon>
                                                        </template>
                                                    </span>
                                                </span>
                                            </div>
                                            <div class="post__body">{m.displayBody}</div>
                                            <template if:true={m.canExpand}>
                                                <div class="post__more slds-m-top_xx-small">
                                                    <button class="slds-button slds-button_reset slds-text-link" data-thread-id={t.Id} data-id={m.Id} onclick={toggleExpand}>{m.expandLabel}</button>
                                                </div>
                                            </template>
                                            <!-- Actions for unsent messages -->
                                            <template if:true={m.isPending}>
                                                <div class="post__actions slds-m-top_small slds-grid slds-grid_align-end slds-gutters_small">
                                                    <div class="slds-col_auto">
                                                        <lightning-button
                                                            data-thread-id={t.Id}
                                                            data-id={m.Id}
                                                            label="送信"
                                                            variant="brand"
                                                            onclick={sendMessage}
                                                        ></lightning-button>
                                                    </div>
                                                    <div class="slds-col_auto slds-m-left_x-small">
                                                        <lightning-button
                                                            data-thread-id={t.Id}
                                                            data-id={m.Id}
                                                            label="削除"
                                                            variant="destructive-text"
                                                            onclick={deleteMessage}
                                                        ></lightning-button>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                    </div>
                                </template>
                                <template if:false={t.messagesLoaded}>
                                    <div class="slds-p-vertical_small slds-text-color_weak">開いて読み込み中...</div>
                                </template>
                                <div class="comment">
                                    <template if:true={t.isClosed}>
                                        <div class="slds-text-color_weak slds-m-bottom_x-small">このスレッドはクローズされています。返信できません。</div>
                                    </template>
                                    <lightning-textarea
                                        data-id={t.Id}
                                        label="コメントを記入する"
                                        placeholder="コメントを記入する"
                                        maxlength="1000"
                                        disabled={t.isClosed}
                                        value={t.newComment}
                                        onchange={handleCommentChange}
                                    ></lightning-textarea>
                                    <div class="counter">{t.commentCount}/1000</div>
                                    <lightning-button
                                        class="slds-m-top_x-small"
                                        data-id={t.Id}
                                        label="コメントする"
                                        variant="brand"
                                        disabled={t.uiDisableComment}
                                        onclick={confirmAndPostComment}
                                    ></lightning-button>
                                </div>
                            </div>
                        </lightning-accordion-section>
                    </template>
                </lightning-accordion>
            </template>
        </div>
    </lightning-card>
</template>
